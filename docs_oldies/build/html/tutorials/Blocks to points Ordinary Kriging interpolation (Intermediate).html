
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Blocks to points Ordinary Kriging interpolation - tutorial &#8212; Pyinterpolate 0.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Semivariogram regularization - tutorial" href="Semivariogram%20Regularization%20%28Intermediate%29.html" />
    <link rel="prev" title="How good is my Kriging model? - tests with IDW algorithm - tutorial" href="How%20good%20is%20our%20Kriging%20model%20-%20test%20%20it%20with%20IDW%20algorithm%20%28Basic%29.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Blocks-to-points-Ordinary-Kriging-interpolation---tutorial">
<h1>Blocks to points Ordinary Kriging interpolation - tutorial<a class="headerlink" href="#Blocks-to-points-Ordinary-Kriging-interpolation---tutorial" title="Permalink to this heading">¶</a></h1>
<section id="Table-of-Contents:">
<h2>Table of Contents:<a class="headerlink" href="#Table-of-Contents:" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Read areal data,</p></li>
<li><p>Detect and remove outliers,</p></li>
<li><p>Create semivariogram model,</p></li>
<li><p>Read point data canvas,</p></li>
<li><p>Build map of interpolated values,</p></li>
<li><p>Show map of interpolated values with choropleth map of breast cancer rates.</p></li>
</ol>
</section>
<section id="Level:-Intermediate">
<h2>Level: Intermediate<a class="headerlink" href="#Level:-Intermediate" title="Permalink to this heading">¶</a></h2>
</section>
<section id="Changelog">
<h2>Changelog<a class="headerlink" href="#Changelog" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Date</p></th>
<th class="head"><p>Change description</p></th>
<th class="head"><p>Author</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2021-05-11</p></td>
<td><p>Refactored TheoreticalSemivariogram class</p></td>
<td><p>&#64;szymon-datalions</p></td>
</tr>
<tr class="row-odd"><td><p>2021-03-31</p></td>
<td><p>Update related to the change of semivariogram weighting. Updated cancer rates data.</p></td>
<td><p>&#64;szymon-datalions</p></td>
</tr>
</tbody>
</table>
</section>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this heading">¶</a></h2>
<p>This tutorial is based on the question of user <em>&#64;ikey</em> from <em>Discord</em> channel of package (02/04/2021). Thank you <em>&#64;ikey</em> for it!</p>
<p>In short:</p>
<blockquote>
<div><p>Are we able to perform Semivariogram Regularization and Poisson Kriging if our point support represents only points without any values?</p>
</div></blockquote>
<p><strong>No, it’s not possible</strong>. But there is a hack which we can use - we are able to interpolate missing values from areal centroids with Ordinary and Simple Kriging just like we do it with <em>regular points</em>. Why is it not possible with unknown points?</p>
<p>The idea behind semivariogram regularization of areal aggregates is to use semivariogram of points (values). And not any points, they must reflect ongoing process. As example, in the case of epidemiology:</p>
<ol class="arabic simple">
<li><p>We have areal counts of infections divided by POPULATION over some area.</p></li>
<li><p>We take POPULATION blocks (points) with number of inhabitants per block and use those as a support of our map. Thus we transform choropleth map into point map, and only to the points, where someone is living ==&gt; someone may be infected. We skip large parts of map where risk of infection is not present because no one is living there.</p></li>
<li><p>And we finally obtain population-at-risk map of points or smoothed choropleth map of infection risk without large visual bias where large/small areas seems to be more important.</p></li>
</ol>
<p>This works when we have specific <strong>counts over area divided by other parameter</strong> (time, population, probability, volume etc.). In this scenario we can find function which links our areal counts with those underlying variables and/or processes. Without support values we are not able to perform semivariogram regularization.</p>
<p>What we want to achieve may be done with Ordinary Kriging (because our points are really unknown) and semivariogram regularization is not required (and not possible without any values).</p>
<p>In summary we will learn how to:</p>
<ul class="simple">
<li><p>transform areal data into points,</p></li>
<li><p>detect and remove outliers from data,</p></li>
<li><p>create interpolated map from unknown points,</p></li>
<li><p>visualize and save created map.</p></li>
</ul>
<p>We use:</p>
<ul class="simple">
<li><p>for point canvas: <code class="docutils literal notranslate"><span class="pre">sample_data/point_data/regular_grid_points.shp</span></code>,</p></li>
<li><p>for areal centroids: Breast cancer rates data is stored in the shapefile in folder <code class="docutils literal notranslate"><span class="pre">sample_data/areal_data/cancer_data.shp</span></code>.</p></li>
</ul>
<p>This tutorial requires understanding of concepts presented in <strong>Semivariogram Estimation</strong> and <strong>Variogram Point Cloud</strong> tutorials along with <strong>Ordinary and Simple Kriging</strong> notebook and (optionally) <strong>Semivariogram Regularization</strong> tutorial.</p>
</section>
<section id="Import-packages">
<h2>Import packages<a class="headerlink" href="#Import-packages" title="Permalink to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
import pandas as pd
import geopandas as gpd

import matplotlib.pyplot as plt

from pyinterpolate.io_ops import prepare_areal_shapefile
from pyinterpolate.semivariance import build_variogram_point_cloud, show_variogram_cloud, remove_outliers
from pyinterpolate.semivariance import calc_semivariance_from_pt_cloud
from pyinterpolate.semivariance import TheoreticalSemivariogram
from pyinterpolate.kriging import Krige
</pre></div>
</div>
</div>
</section>
<section id="1)-Read-areal-data">
<h2>1) Read areal data<a class="headerlink" href="#1)-Read-areal-data" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>areal = &#39;../sample_data/areal_data/cancer_data.shp&#39;
id_col = &#39;FIPS&#39;
val_col = &#39;rate&#39;
dataset = prepare_areal_shapefile(areal, id_column_name=id_col, value_column_name=val_col)
dataset[0]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([25019,
       &lt;shapely.geometry.multipolygon.MultiPolygon object at 0x7f070c41d050&gt;,
       2132629.599151873, 557971.1559491967, 192.2], dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data_centroids = dataset[:, -3:]
data_centroids[0]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([2132629.599151873, 557971.1559491967, 192.2], dtype=object)
</pre></div></div>
</div>
<section id="Clarification:">
<h3>Clarification:<a class="headerlink" href="#Clarification:" title="Permalink to this heading">¶</a></h3>
<p>Prepared areal shapefile has five columns: <code class="docutils literal notranslate"><span class="pre">[area</span> <span class="pre">id,</span> <span class="pre">geometry,</span> <span class="pre">centroid</span> <span class="pre">x,</span> <span class="pre">centroid</span> <span class="pre">y,</span> <span class="pre">value]</span></code>. We don’t need polygons’ geometry and areas’ id in the case of point kriging. Prepared array is sliced and in return we get array of centroids and their values. This is our base for modeling.</p>
</section>
</section>
<section id="2)-Detect-and-remove-outliers">
<h2>2) Detect and remove outliers<a class="headerlink" href="#2)-Detect-and-remove-outliers" title="Permalink to this heading">¶</a></h2>
<p>We check and clean data before semivariogram fit and Ordinary Kriging. Variogram Point Cloud is the best way to analyze data and detect outliers which may affect further analysis. We check and compare few different lags and step sizes and their respective point clouds. Then we will use those different number of ranges to create multiple semivariogram and Kriging models.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Create analysis parameters

maximum_range = 300000

number_of_lags = [4, 8, 16]
step_sizes = [maximum_range / x for x in number_of_lags]

variogram_clouds = []

for step_size in step_sizes:
    variogram_cloud = build_variogram_point_cloud(data_centroids, step_size, maximum_range)
    variogram_clouds.append(variogram_cloud)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for idx, lag in enumerate(number_of_lags):
    print(f&#39;Lags per area: {lag}&#39;)
    print(&#39;&#39;)
    var_cloud = variogram_clouds[idx]
    show_variogram_cloud(var_cloud, figsize=(12, 8))

    print(&#39;\n###########\n&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lags per area: 4

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_9_1.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_9_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

###########

Lags per area: 8

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_9_3.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_9_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

###########

Lags per area: 16

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_9_5.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_9_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

###########

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Now remove outliers from each lag

clouds_without_outliers = [remove_outliers(x) for x in variogram_clouds]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># And show data without outliers

for idx, lag in enumerate(number_of_lags):
    print(f&#39;Lags per area: {lag}&#39;)
    print(&#39;&#39;)
    var_cloud = clouds_without_outliers[idx]
    show_variogram_cloud(var_cloud, figsize=(12, 8))

    print(&#39;\n###########\n&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lags per area: 4

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_11_1.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_11_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

###########

Lags per area: 8

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_11_3.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_11_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

###########

Lags per area: 16

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_11_5.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_11_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

###########

</pre></div></div>
</div>
<section id="id1">
<h3>Clarification:<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<p>It could be not visible, but we got rid off outliers from dataset. Look into <strong>y</strong> axes of variogram clouds with and without outliers for each lag. You hopefully see that maximum values after data cleaning are two times smaller. We can test different lags now to create semivariogram models.</p>
</section>
</section>
<section id="3.-Create-semivariogram-model">
<h2>3. Create semivariogram model<a class="headerlink" href="#3.-Create-semivariogram-model" title="Permalink to this heading">¶</a></h2>
<p>Semivariogram may be fitted manually or automatically. In this case we fit it automatically - we test multiple models and it’s easier to use <code class="docutils literal notranslate"><span class="pre">find_optimal_model()</span></code> method of <code class="docutils literal notranslate"><span class="pre">TheoreticalSemivariogram</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>theoretical_semivariograms = []

for idx, cloud_model in enumerate(clouds_without_outliers):

    print(f&#39;Semivariance calculated for {number_of_lags[idx]} lag&#39;)
    print(&#39;&#39;)
    # Calculate experimental model
    exp_model = calc_semivariance_from_pt_cloud(cloud_model)

    # Assign experimental model and data to TheoreticalSemivariogram
    theo_semi = TheoreticalSemivariogram(points_array=data_centroids,
                                         empirical_semivariance=exp_model,
                                         verbose=True)
    theo_semi.find_optimal_model(weighted=False, number_of_ranges=number_of_lags[idx])
    theoretical_semivariograms.append(theo_semi)
    print(&#39;&#39;)
    print(&#39;Model parameters:&#39;)
    print(&#39;Nugget:&#39;, theo_semi.nugget)
    print(&#39;Sill:&#39;, theo_semi.sill)
    print(&#39;Range:&#39;, theo_semi.range)
    print(&#39;&#39;)
    print(&#39;#####&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Semivariance calculated for 4 lag

Model: spherical, error value: 47.46959781307264
Model: exponential, error value: 12.409730137628472
Model: linear, error value: 33.73740642254563
Chosen model: exponential, with value: 12.409730137628472.

Model parameters:
Nugget: 40.84634146341462
Sill: 171.27273206056609
Range: 225000.0

#####
Semivariance calculated for 8 lag

Model: spherical, error value: 29.50306496934048
Model: exponential, error value: 18.445105479962933
Model: linear, error value: 31.969300956642797
Chosen model: exponential, with value: 18.445105479962933.

Model parameters:
Nugget: 1.6961373390557952
Sill: 171.27273206056609
Range: 133928.57142857142

#####
Semivariance calculated for 16 lag

Model: spherical, error value: 33.17075686586436
Model: exponential, error value: 22.57867885361459
Model: linear, error value: 36.236544305662264
Chosen model: exponential, with value of: 22.57867885361459.

Model parameters:
Nugget: 0.0
Sill: 171.27273206056609
Range: 123750.0

#####
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/szymon/miniconda3/envs/pyintpk/lib/python3.7/site-packages/numpy/core/fromnumeric.py:3335: RuntimeWarning: Mean of empty slice.
  out=out, **kwargs)
/home/szymon/miniconda3/envs/pyintpk/lib/python3.7/site-packages/pyinterpolate/semivariance/semivariogram_fit/fit_semivariance.py:302: UserWarning: WARNING: linear model fitted to the experimental variogram is better than the core models!
  warnings.warn(warning_msg)
</pre></div></div>
</div>
<section id="id2">
<h3>Clarification:<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p><em>Exponential</em> model was chosen in each case. This model offers lowest error of fitting. If we look only into the error value then we may assume that the best model is for 4 lags… but when we compare different parameters of semivariogram model we see interesting things.</p>
<p><strong>Nugget</strong> of four lags is large and it’s 30 cases per 100,000 inhabitants. Why is that? Model with only four lags catches large distance near the zero origin and it introduces bias. Other lags have nugget close to 0.</p>
<p><strong>Range</strong> of the first model is very large compared to the areal bounds and it is a half of them. Range of 8 and 16 lags is closer to each other and more than two-three times smaller than range of 4 lags. It’s the same effect of large spacing for 4 lags.</p>
<p><strong>Sill</strong> is the same because it describes variance in dataset (which is constant).</p>
<p>Summarizing: 4-lags model has lowest error of fit but largest nugget and range. 8- and 16-lags models have comparable nugget and range. Probably one of these models will be a better fit for Kriging.</p>
</section>
</section>
<section id="4.-Read-point-data-canvas">
<h2>4. Read point data canvas<a class="headerlink" href="#4.-Read-point-data-canvas" title="Permalink to this heading">¶</a></h2>
<p><strong>Pyinterpolate</strong> doesn’t have function for read point data directly from shapefile (2021-02-07) but we can do it with <strong>GeoPandas</strong> package. <strong>Pyinterpolate</strong> uses <strong>GeoPandas</strong> under the hood so there is no problem with import of this package.</p>
<p>We read point file as the <strong>GeoDataFrame</strong> object which stores geometry column and data features as tables.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>points = &#39;../sample_data/point_data/regular_grid_points.shp&#39;  # file with grid for analysis
gdf_pts = gpd.read_file(points)
gdf_pts.set_index(&#39;id&#39;, inplace=True)
gdf_pts.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>81.0</th>
      <td>POINT (1277277.671 441124.507)</td>
    </tr>
    <tr>
      <th>82.0</th>
      <td>POINT (1277277.671 431124.507)</td>
    </tr>
    <tr>
      <th>83.0</th>
      <td>POINT (1277277.671 421124.507)</td>
    </tr>
    <tr>
      <th>84.0</th>
      <td>POINT (1277277.671 411124.507)</td>
    </tr>
    <tr>
      <th>85.0</th>
      <td>POINT (1277277.671 401124.507)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Now we interpolate value for each point with Kriging. We use <code class="docutils literal notranslate"><span class="pre">apply()</span></code> on geometry column and create new columns of <em>GeoDataFrame</em> with interpolated results.</p>
</section>
<section id="5.-Build-map-of-interpolated-values">
<h2>5. Build map of interpolated values<a class="headerlink" href="#5.-Build-map-of-interpolated-values" title="Permalink to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Set kriging models

def krige_point(pt, k_model, no_of_neighbors=8):
    &quot;&quot;&quot;
    Function predicts value at unknown location with 8 closest neighbors and given kriging model.

    INPUT:

    :param pt: (shapely Point),
    :param k_model: (Krige),
    :param no_of_neighbors: (int)

    OUTPUT:

    :return: (float)
    &quot;&quot;&quot;
    val = k_model.ordinary_kriging(unknown_location=[pt.x, pt.y], number_of_neighbours=no_of_neighbors)
    return pd.Series([val[0], val[1]])

kriging_models = []
for idx, semi_model in enumerate(theoretical_semivariograms):
    kriging_model = Krige(semivariogram_model=semi_model, known_points=data_centroids)
    col_name = &#39;lags_&#39; + str(number_of_lags[idx])
    err_col_name = &#39;e_&#39; + col_name

    # Interpolate missing values and uncertainty
    gdf_pts[[col_name, err_col_name]] = gdf_pts.geometry.apply(krige_point, args=[kriging_model])

    # Append model
    kriging_models.append(kriging_model)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>gdf_pts.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>lags_4</th>
      <th>e_lags_4</th>
      <th>lags_8</th>
      <th>e_lags_8</th>
      <th>lags_16</th>
      <th>e_lags_16</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>81.0</th>
      <td>POINT (1277277.671 441124.507)</td>
      <td>131.471425</td>
      <td>6.302487</td>
      <td>131.624497</td>
      <td>4.819975</td>
      <td>131.648728</td>
      <td>4.855153</td>
    </tr>
    <tr>
      <th>82.0</th>
      <td>POINT (1277277.671 431124.507)</td>
      <td>130.587922</td>
      <td>5.862754</td>
      <td>130.764126</td>
      <td>4.568737</td>
      <td>130.793961</td>
      <td>4.606546</td>
    </tr>
    <tr>
      <th>83.0</th>
      <td>POINT (1277277.671 421124.507)</td>
      <td>129.720084</td>
      <td>5.415435</td>
      <td>129.918570</td>
      <td>4.211067</td>
      <td>129.953698</td>
      <td>4.251812</td>
    </tr>
    <tr>
      <th>84.0</th>
      <td>POINT (1277277.671 411124.507)</td>
      <td>129.005726</td>
      <td>5.557726</td>
      <td>129.317708</td>
      <td>4.287956</td>
      <td>129.374854</td>
      <td>4.328610</td>
    </tr>
    <tr>
      <th>85.0</th>
      <td>POINT (1277277.671 401124.507)</td>
      <td>128.936991</td>
      <td>5.466700</td>
      <td>128.982976</td>
      <td>4.266100</td>
      <td>128.992189</td>
      <td>4.309141</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<section id="id3">
<h3>Clarification:<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>This is rather complicated function in which we interpolate missing values as a new columns of <strong>GeoDataFrame</strong>. <em>Uncertainty</em> is assigned to interpolated results for further analysis.</p>
<p>Now we can save our <strong>GeoDataFrame</strong> as a shapefile…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Save interpolation results

gdf_pts.to_file(&#39;interpolation_results_areal_to_point.shp&#39;)
</pre></div>
</div>
</div>
<p>or check results directly in a notebook!</p>
</section>
</section>
<section id="6.-Show-map-of-interpolated-values-with-choropleth-map-of-breast-cancer-rates">
<h2>6. Show map of interpolated values with choropleth map of breast cancer rates<a class="headerlink" href="#6.-Show-map-of-interpolated-values-with-choropleth-map-of-breast-cancer-rates" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># First read areal shapefile

gdf = gpd.read_file(areal)
gdf.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rate</th>
      <th>FIPS</th>
      <th>rate_float</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>192.2</td>
      <td>25019</td>
      <td>192.2</td>
      <td>MULTIPOLYGON (((2115688.816 556471.240, 211569...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>166.8</td>
      <td>36121</td>
      <td>166.8</td>
      <td>POLYGON ((1419423.430 564830.379, 1419729.721 ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>157.4</td>
      <td>33001</td>
      <td>157.4</td>
      <td>MULTIPOLYGON (((1937530.728 779787.978, 193751...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>156.7</td>
      <td>25007</td>
      <td>156.7</td>
      <td>MULTIPOLYGON (((2074073.532 539159.504, 207411...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>155.3</td>
      <td>25001</td>
      <td>155.3</td>
      <td>MULTIPOLYGON (((2095343.207 637424.961, 209528...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Now compare results to choropleth maps

fs = (6, 8)

for lag in number_of_lags:
    print(&#39;Lag&#39;, lag)
    col_name = &#39;lags_&#39; + str(lag)
    plt.figure()
    base = gdf.plot(figsize=fs, column=&#39;rate&#39;, cmap=&#39;Spectral_r&#39;, legend=True)
    gdf_pts.plot(ax=base, column=col_name, cmap=&#39;Spectral_r&#39;)
    plt.show()
    print(&#39;######&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lag 4
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_27_2.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_27_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
######
Lag 8
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_27_5.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_27_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
######
Lag 16
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_27_8.png" src="../_images/tutorials_Blocks_to_points_Ordinary_Kriging_interpolation_(Intermediate)_27_8.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
######
</pre></div></div>
</div>
<section id="id4">
<h3>Clarification:<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>Visual inspection shows that:</p>
<ol class="arabic simple">
<li><p>Interpolated results are more smoothed over area and in the most part of a map they are similar to the rate observed in specific county.</p></li>
<li><p>Difference between interpolated points is not visible. Is there any?</p></li>
</ol>
<p>To answer second question we calculate the Mean Absolute Difference between each lag’s interpolated results.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for lag1 in number_of_lags:
    print(&#39;LAG:&#39;, lag1)
    col_name1 = &#39;lags_&#39; + str(lag1)
    for lag2 in number_of_lags:
        if lag1 == lag2:
            pass
        else:
            col_name2 = &#39;lags_&#39; + str(lag2)
            mad = gdf_pts[col_name1] - gdf_pts[col_name2]
            mad = np.abs(np.mean(mad))
            print(&#39;&#39;)
            print(f&#39;Mean Absolute Difference between lag {lag1} and lag {lag2} is {mad:.6f}&#39;)
            print(&#39;&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LAG: 4

Mean Absolute Difference between lag 4 and lag 8 is 0.043591


Mean Absolute Difference between lag 4 and lag 16 is 0.052167

LAG: 8

Mean Absolute Difference between lag 8 and lag 4 is 0.043591


Mean Absolute Difference between lag 8 and lag 16 is 0.008576

LAG: 16

Mean Absolute Difference between lag 16 and lag 4 is 0.052167


Mean Absolute Difference between lag 16 and lag 8 is 0.008576

</pre></div></div>
</div>
</section>
<section id="id5">
<h3>Clarification:<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p>As you see those differences are really small. Each semivariogram model is similar in this case. In this case we can use <strong>4-lag</strong> model. It will be calculted faster than other models and it is still very similar to other models.</p>
<hr class="docutils" />
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Pyinterpolate</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Setup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.html">Algorithms Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contribution to Pyinterpolate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../tutorials.html">Tutorials</a><ul>
      <li>Previous: <a href="How%20good%20is%20our%20Kriging%20model%20-%20test%20%20it%20with%20IDW%20algorithm%20%28Basic%29.html" title="previous chapter">How good is my Kriging model? - tests with IDW algorithm - tutorial</a></li>
      <li>Next: <a href="Semivariogram%20Regularization%20%28Intermediate%29.html" title="next chapter">Semivariogram regularization - tutorial</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Szymon Moliński.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/tutorials/Blocks to points Ordinary Kriging interpolation (Intermediate).ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>