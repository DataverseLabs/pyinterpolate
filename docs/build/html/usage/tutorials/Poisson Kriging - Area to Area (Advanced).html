

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Poisson Kriging - Area to Area Kriging &#8212; Pyinterpolate 0.5 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'usage/tutorials/Poisson Kriging - Area to Area (Advanced)';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Poisson Kriging - Area to Point Kriging" href="Poisson%20Kriging%20-%20Area%20to%20Point%20%28Advanced%29.html" />
    <link rel="prev" title="Poisson Kriging - centroid based approach" href="Poisson%20Kriging%20-%20Centroid%20Based%20%28Advanced%29.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">Pyinterpolate 0.5 documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../setup/setup.html">
                        Setup
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../quickstart.html">
                        Quickstart
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../science/cite.html">
                        How to cite
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../api/api.html">
                        API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developer/dev.html">
                        Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../community/community.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../learning_materials.html">
                        Learning Materials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../science/biblio.html">
                        Bibliography
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../setup/setup.html">
                        Setup
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../quickstart.html">
                        Quickstart
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../science/cite.html">
                        How to cite
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../api/api.html">
                        API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developer/dev.html">
                        Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../community/community.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../learning_materials.html">
                        Learning Materials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../science/biblio.html">
                        Bibliography
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Semivariogram%20Estimation%20%28Basic%29.html">Semivariogram Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Theoretical%20Models%20%28Basic%29.html">Semivariogram models</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spatial%20Dependence%20Index%20%28Basic%29.html">Spatial Dependence Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="Variogram%20Point%20Cloud%20%28Basic%29.html">Variogram Point Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="Directional%20Semivariograms%20%28Basic%29.html">Directional semivariograms</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ordinary%20and%20Simple%20Kriging%20%28Basic%29.html">Ordinary and Simple Kriging</a></li>
<li class="toctree-l1"><a class="reference internal" href="How%20good%20is%20our%20Kriging%20model%20-%20test%20it%20against%20IDW%20algorithm%20%28Basic%29.html">How good is my Kriging model? - tests with IDW algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="Experimental%20Variogram%20and%20Variogram%20Point%20Cloud%20classes%20%28Basic%29.html">Experimental Variogram and Variogram Cloud classes</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Semivariogram%20Regularization%20%28Intermediate%29.html">Semivariogram regularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="Blocks%20to%20points%20Ordinary%20Kriging%20interpolation%20%28Intermediate%29.html">Blocks to points Ordinary Kriging interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Directional%20Ordinary%20Kriging%20%28Intermediate%29.html">Directional Ordinary Kriging</a></li>
<li class="toctree-l1"><a class="reference internal" href="Outliers%20and%20Their%20Influence%20on%20the%20Final%20Model%20%28Intermediate%29.html">Outliers and Their Influence on the Final Model</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Poisson%20Kriging%20-%20Centroid%20Based%20%28Advanced%29.html">Poisson Kriging - centroid based approach</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Poisson Kriging - Area to Area Kriging</a></li>
<li class="toctree-l1"><a class="reference internal" href="Poisson%20Kriging%20-%20Area%20to%20Point%20%28Advanced%29.html">Poisson Kriging - Area to Point Kriging</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Poisson Kriging - Area to Area Kriging</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="Poisson-Kriging---Area-to-Area-Kriging">
<h1>Poisson Kriging - Area to Area Kriging<a class="headerlink" href="#Poisson-Kriging---Area-to-Area-Kriging" title="Permalink to this heading">#</a></h1>
<section id="Table-of-Contents:">
<h2>Table of Contents:<a class="headerlink" href="#Table-of-Contents:" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Load areal and point data,</p></li>
<li><p>Load semivariogram (regularized),</p></li>
<li><p>Remove 40% of areal dataset,</p></li>
<li><p>Predict values at unknown locations,</p></li>
<li><p>Analyse Forecast Bias and Root Mean Squared Error of prediction.</p></li>
</ol>
</section>
<section id="Level:-Advanced">
<h2>Level: Advanced<a class="headerlink" href="#Level:-Advanced" title="Permalink to this heading">#</a></h2>
</section>
<section id="Changelog">
<h2>Changelog<a class="headerlink" href="#Changelog" title="Permalink to this heading">#</a></h2>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Date</p></th>
<th class="head"><p>Change description</p></th>
<th class="head"><p>Author</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2023-01-14</p></td>
<td><p>New area-to-area PK algorithm</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-odd"><td><p>2022-10-21</p></td>
<td><p>The tutorial was updated for the 0.3.4 version of the package</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-even"><td><p>2022-08-27</p></td>
<td><p>The tutorial was updated for the 0.3.0 version of the package</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-odd"><td><p>2021-12-14</p></td>
<td><p>Sill selection was upgraded: now optimal sill is derived from the grid search within <code class="docutils literal notranslate"><span class="pre">TheoreticalSemivariogram</span></code> class</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-even"><td><p>2021-12-13</p></td>
<td><p>Changed behavior of <code class="docutils literal notranslate"><span class="pre">select_values_in_range()</span></code> function</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-odd"><td><p>2021-12-11</p></td>
<td><p>Behavior of <code class="docutils literal notranslate"><span class="pre">prepare_kriging_data()</span></code> function has benn changed</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-even"><td><p>2021-05-28</p></td>
<td><p>Updated paths for input/output data</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-odd"><td><p>2021-05-11</p></td>
<td><p>Refactored TheoreticalSemivariogram class</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
<tr class="row-even"><td><p>2021-03-31</p></td>
<td><p>Update related to the change of semivariogram weighting. Updated cancer rates data.</p></td>
<td><p>&#64;SimonMolinsky</p></td>
</tr>
</tbody>
</table>
</section>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this heading">#</a></h2>
<p>Before starting this tutorial, be sure you understand concepts in the <strong>Ordinary and Simple Kriging</strong> and <strong>Semivariogram Regularization</strong> tutorials.</p>
<p>The Poisson Kriging technique is used to model spatial count data. We will analyze a particular case where values are counted over blocks, and those blocks may have irregular shapes and sizes. We will try to predict the breast cancer rates in the Northeastern counties of the U.S. We will use U.S. Census 2010 data to create point support for blocks.</p>
<blockquote>
<div><p>The breast cancer rates data and the point support population counts are located in the geopackage in a directory: <code class="docutils literal notranslate"><span class="pre">samples/regularization/cancer_data.gpkg</span></code></p>
</div></blockquote>
<p>In tutorial <strong>Poisson Kriging - Centroid based approach</strong> we’ve assumed that all areas have the same size and shape. It is not a valid statement. Now we use the Area-to-Area Kriging technique and predict and evaluate missing values.</p>
<p>Area-to-Area and Area-to-Point Poisson Kriging are slower than simplified Kriging with Centroids but give more reliable results because they are tuned to areal size and shape.</p>
<p>This tutorial covers the following steps:</p>
<ol class="arabic simple">
<li><p>Read and explore data,</p></li>
<li><p>Load semivariogram model,</p></li>
<li><p>Prepare training and test data,</p></li>
<li><p>Predict values of unknown locations and calculate forecast bias and root mean squared error,</p></li>
<li><p>Analyze error metrics.</p></li>
</ol>
</section>
<section id="1)-Read-and-explore-data">
<h2>1) Read and explore data<a class="headerlink" href="#1)-Read-and-explore-data" title="Permalink to this heading">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
import pandas as pd

from pyinterpolate import TheoreticalVariogram
from pyinterpolate import Blocks, PointSupport
from pyinterpolate import area_to_area_pk
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>DATASET = &#39;samples/regularization/cancer_data.gpkg&#39;
OUTPUT = &#39;samples/regularization/regularized_variogram.json&#39;
POLYGON_LAYER = &#39;areas&#39;
POPULATION_LAYER = &#39;points&#39;
POP10 = &#39;POP10&#39;
GEOMETRY_COL = &#39;geometry&#39;
POLYGON_ID = &#39;FIPS&#39;
POLYGON_VALUE = &#39;rate&#39;

blocks = Blocks()
blocks.from_file(DATASET, value_col=POLYGON_VALUE, index_col=POLYGON_ID, layer_name=POLYGON_LAYER)

point_support = PointSupport()
point_support.from_files(point_support_data_file=DATASET,
                         blocks_file=DATASET,
                         point_support_geometry_col=GEOMETRY_COL,
                         point_support_val_col=POP10,
                         blocks_geometry_col=GEOMETRY_COL,
                         blocks_index_col=POLYGON_ID,
                         use_point_support_crs=True,
                         point_support_layer_name=POPULATION_LAYER,
                         blocks_layer_name=POLYGON_LAYER)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Lets take a look into a map of areal counts

blocks.data.plot(column=blocks.value_column_name, cmap=&#39;Spectral_r&#39;, legend=True, figsize=(12, 8))
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: &gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/usage_tutorials_Poisson_Kriging_-_Area_to_Area_%28Advanced%29_4_1.png" src="../../_images/usage_tutorials_Poisson_Kriging_-_Area_to_Area_%28Advanced%29_4_1.png" />
</div>
</div>
<p><strong>Clarification</strong>: It is a good idea to look into the spatial patterns in a dataset and to visually check if our data do not have any NaN values. We use the geopandas <code class="docutils literal notranslate"><span class="pre">GeoDataFrame.plot()</span></code> function with a color map that diverges regions based on the cancer incidence rates. The output choropleth map is not ideal, and (probably) it has a few unreliable results, for example:</p>
<ul class="simple">
<li><p>in counties with a small population, where the ratio number of cases to population size is high even if the number of cases is low,</p></li>
<li><p>counties that are very big and sparsely populated may draw more of our attention instead of densely populated counties,</p></li>
<li><p>transitions of colors (rates) between counties may be too abrupt, even if we know, that neighboring counties should have closer results.</p></li>
</ul>
<p>We can overcome those problems using Area-to-Area Kriging for filtering and denoising. But, in this tutorial, we will make an interpolation with Area-to-Area Kriging and analyze root mean squared errors of predictions and their bias.</p>
</section>
<section id="2)-Load-a-semivariogram-model">
<h2>2) Load a semivariogram model<a class="headerlink" href="#2)-Load-a-semivariogram-model" title="Permalink to this heading">#</a></h2>
<p>In this step, we load regularized semivariogram from the tutorial <strong>Semivariogram Regularization (Intermediate)</strong>. You can always perform semivariogram regularization along with the Poisson Kriging, but it is a very long process, and it is more convenient to separate those two steps.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>semivariogram = TheoreticalVariogram()  # Create TheoreticalSemivariogram object
semivariogram.from_json(&#39;output/regularized_model.json&#39;)  # Load regularized semivariogram
</pre></div>
</div>
</div>
</section>
<section id="3)-Prepare-training-and-test-data.">
<h2>3) Prepare training and test data.<a class="headerlink" href="#3)-Prepare-training-and-test-data." title="Permalink to this heading">#</a></h2>
<p>We simply remove 40% of random ID’s from the areal dataset (the same for points) and create four arrays: two training arrays with areal and point geometry and values and two test arrays with the same categories of data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Remove 40% of rows (values) to test our model

def create_test_areal_set(areal_dataset: Blocks, points_dataset: PointSupport, frac=0.4):
    &quot;&quot;&quot;

    Parameters
    ----------
    areal_dataset : Blocks
    points_dataset : PointSupport
    frac : float

    Returns
    -------
    : List
        [[training_areas, test_areas, training_points, test_points]]
            equal to:
        [np.ndarray, np.ndarray, np.ndarray, np.ndarray]
            where:
        - areas: [[block index, centroid x, centroid y, value]]
        - point support: [[block id, x, y, value]]
    &quot;&quot;&quot;
    block_id_col = areal_dataset.index_column_name
    block_data = areal_dataset.data.copy()
    all_ids = block_data[block_id_col].unique()
    training_set_size = int(len(all_ids) * (1 - frac))

    training_ids = np.random.choice(all_ids,
                                    size=training_set_size,
                                    replace=False)

    training_areas = block_data[block_data[block_id_col].isin(training_ids)]
    training_areas = training_areas[[block_id_col, &#39;centroid_x&#39;, &#39;centroid_y&#39;, areal_dataset.value_column_name]].values
    test_areas = block_data[~block_data[block_id_col].isin(training_ids)]
    test_areas = test_areas[[block_id_col, &#39;centroid_x&#39;, &#39;centroid_y&#39;, areal_dataset.value_column_name]].values

    ps_data = points_dataset.point_support.copy()
    ps_ids = points_dataset.block_index_column

    training_points = ps_data[ps_data[ps_ids].isin(training_ids)]
    training_points = training_points[[ps_ids,
                                       points_dataset.x_col,
                                       points_dataset.y_col,
                                       points_dataset.value_column]].values
    test_points = ps_data[~ps_data[ps_ids].isin(training_ids)]
    test_points = test_points[[ps_ids,
                               points_dataset.x_col,
                               points_dataset.y_col,
                               points_dataset.value_column]].values


    output = [training_areas, test_areas, training_points, test_points]
    return output

ar_train, ar_test, pt_train, pt_test = create_test_areal_set(blocks, point_support)
</pre></div>
</div>
</div>
</section>
<section id="4)-Predict-values-at-unknown-locations-and-calculate-forecast-bias-and-root-mean-squared-error.">
<h2>4) Predict values at unknown locations and calculate forecast bias and root mean squared error.<a class="headerlink" href="#4)-Predict-values-at-unknown-locations-and-calculate-forecast-bias-and-root-mean-squared-error." title="Permalink to this heading">#</a></h2>
<p>Do you know scikit-learn’s fit-predict-transform estimation procedure? With Kriging, it is more complicated because we fit the semivariogram model to data, and we pass this fitted model into the kriging estimator.</p>
<p>You may start work with predictions with a fitted semivariogram model. The run of Area-to-Area Poisson Kriging requires five core arguments:</p>
<ul class="simple">
<li><p>semivariogram model (fitted semivariogram model),</p></li>
<li><p>known areas (training set),</p></li>
<li><p>known points (training set),</p></li>
<li><p>unknown-block (without rate value),</p></li>
<li><p>unknown block’s point support.</p></li>
</ul>
<p>Additional parameters control the interpolation process:</p>
<ul class="simple">
<li><p><strong>number of observations</strong> (the most critical parameter - how many neighbors are affecting your analysis area).</p></li>
</ul>
<p>The algorithm in the cell below iteratively picks one location from the test set and performs interpolation. Then forecast bias, the difference between the actual and predicted value, is calculated. Forecast Bias is helpful in understanding if our algorithm predictions are too low or too high (under- or overestimation). The following parameter is Root Mean Squared Error. This measure tells us more about outliers and considerable differences between predictions and actual values. We will see it
in the last part of the tutorial.</p>
<p>Your work with Poisson Kriging (or Kriging) will usually be the same: - prepare training and test data, - use training data to train the semivariogram model, - test different hyperparameters with a test set to find the optimal number of neighbors which are affecting your area of analysis, - forecast into unknown areas OR perform data smoothing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>number_of_obs = 6

predslist = []
for unknown_area in ar_test:
    upts = pt_test[pt_test[:, 0] == unknown_area[0]]
    upts = upts[:, 1:]
    # [unknown block index, prediction, error]
    try:
        kriging_preds = area_to_area_pk(
            semivariogram_model=semivariogram,
            blocks=ar_train,
            point_support=pt_train,
            unknown_block=unknown_area[:-1],
            unknown_block_point_support=upts,
            number_of_neighbors=number_of_obs,
            raise_when_negative_prediction=True,
            raise_when_negative_error=True
        )
    except ValueError:
        predslist.append([unknown_area[0], np.nan, np.nan, np.nan, np.nan])
    else:
        rmse = np.sqrt((kriging_preds[1] - unknown_area[-1])**2)
        fb = unknown_area[-1] - kriging_preds[1]
        kriging_preds.extend([rmse, fb, unknown_area[-1]])
        predslist.append(kriging_preds)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kriged_predictions = np.array(predslist)
pred_df = pd.DataFrame(data=kriged_predictions[:, 1:],
                       index=kriged_predictions[:, 0],
                       columns=[&#39;predicted&#39;, &#39;err&#39;, &#39;rmse&#39;, &#39;fb&#39;, &#39;real&#39;])  # Store results in DataFrame
</pre></div>
</div>
</div>
</section>
<section id="5)-Analyze-Forecast-Bias-and-Root-Mean-Squared-Error-of-prediction">
<h2>5) Analyze Forecast Bias and Root Mean Squared Error of prediction<a class="headerlink" href="#5)-Analyze-Forecast-Bias-and-Root-Mean-Squared-Error-of-prediction" title="Permalink to this heading">#</a></h2>
<p>The last step is the analysis of errors. We plot two histograms: forecast bias and root mean squared error then we calculate the base statistics of a dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Show histograms of errors

pred_df[&#39;fb&#39;].plot.hist(bins=10)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: ylabel=&#39;Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/usage_tutorials_Poisson_Kriging_-_Area_to_Area_%28Advanced%29_15_1.png" src="../../_images/usage_tutorials_Poisson_Kriging_-_Area_to_Area_%28Advanced%29_15_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pred_df[&#39;rmse&#39;].plot.hist(bins=10)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: ylabel=&#39;Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/usage_tutorials_Poisson_Kriging_-_Area_to_Area_%28Advanced%29_16_1.png" src="../../_images/usage_tutorials_Poisson_Kriging_-_Area_to_Area_%28Advanced%29_16_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pred_df.describe()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>predicted</th>
      <th>err</th>
      <th>rmse</th>
      <th>fb</th>
      <th>real</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>87.000000</td>
      <td>87.000000</td>
      <td>87.000000</td>
      <td>87.000000</td>
      <td>87.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>131.414129</td>
      <td>9.273241</td>
      <td>9.444325</td>
      <td>1.445641</td>
      <td>132.859770</td>
    </tr>
    <tr>
      <th>std</th>
      <td>6.395406</td>
      <td>1.333636</td>
      <td>7.157536</td>
      <td>11.804600</td>
      <td>12.861964</td>
    </tr>
    <tr>
      <th>min</th>
      <td>119.445181</td>
      <td>6.102468</td>
      <td>0.198332</td>
      <td>-24.827458</td>
      <td>100.600000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>126.991464</td>
      <td>8.564454</td>
      <td>3.488055</td>
      <td>-6.311855</td>
      <td>122.650000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>130.448517</td>
      <td>9.130718</td>
      <td>8.164602</td>
      <td>1.223420</td>
      <td>134.300000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>134.199378</td>
      <td>10.094595</td>
      <td>13.087133</td>
      <td>9.917170</td>
      <td>142.200000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>154.374404</td>
      <td>13.949861</td>
      <td>34.580248</td>
      <td>34.580248</td>
      <td>166.800000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><strong>Clarification</strong>: Analysis of <strong>Forecast Bias</strong> and <strong>Root Mean Squared Error</strong> - their distribution and basic properties - could be a handy tool to analyze model performance. However, consider that table above is a single test case (realization) and can be misleading. The good idea is to repeat the test dozens of times with a different training/test set division each time. After this, we average results from multiple tests and get insight into how our model behaves.</p>
<p><strong>Note 1</strong>: Those results are not decisive. Our sample has been selected randomly, and there is a chance that it is not a spatially representative sample! (E.g., areas only from one region). The good idea is to repeat the experiment multiple times with other samples and average results to determine how well the model performs.</p>
<p><strong>Note 2</strong>: If we analyze errors’ statistics, we should consider not only the <em>mean</em> value of an error. Let’s take a look at different pieces of information:</p>
<ul class="simple">
<li><p>Histograms clearly show us how dispersed and grouped are errors, and what’s most important, we directly see the worse predictions and how many of them are generated by our model.</p></li>
<li><p>What is plotted on a histogram, is described by statistics. We may check the max and the min error, but the true power comes when we analyze quartiles and standard deviation.</p></li>
<li><p>The standard deviation is a good measurement of our model’s variance, the less, the better.</p></li>
<li><p>Sometimes, we have to look into quartiles. A very high mean but relatively low median (or even the 3rd quartile) indicates that we have only a few wrong predictions, most of which are acceptable.</p></li>
</ul>
<hr class="docutils" />
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Poisson%20Kriging%20-%20Centroid%20Based%20%28Advanced%29.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Poisson Kriging - centroid based approach</p>
      </div>
    </a>
    <a class="right-next"
       href="Poisson%20Kriging%20-%20Area%20to%20Point%20%28Advanced%29.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Poisson Kriging - Area to Point Kriging</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Table-of-Contents:">Table of Contents:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Level:-Advanced">Level: Advanced</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Changelog">Changelog</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#1)-Read-and-explore-data">1) Read and explore data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#2)-Load-a-semivariogram-model">2) Load a semivariogram model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#3)-Prepare-training-and-test-data.">3) Prepare training and test data.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#4)-Predict-values-at-unknown-locations-and-calculate-forecast-bias-and-root-mean-squared-error.">4) Predict values at unknown locations and calculate forecast bias and root mean squared error.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#5)-Analyze-Forecast-Bias-and-Root-Mean-Squared-Error-of-prediction">5) Analyze Forecast Bias and Root Mean Squared Error of prediction</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../../_sources/usage/tutorials/Poisson Kriging - Area to Area (Advanced).ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, Szymon Moliński.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>